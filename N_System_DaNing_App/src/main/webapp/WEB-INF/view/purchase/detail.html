<!DOCTYPE html>
<html>

<head>
    <title>上海市闸北区大宁国际学校</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection"content="telephone=no, email=no" />
    <link rel="stylesheet" href="/css/ionic.min.css">
    <link rel="stylesheet" href="/css/mobiscroll.custom-2.17.1.min.css">
    <link rel="stylesheet" href="/css/app.css">
    <script src="/js/ionic.bundle.min.js"></script>
    <script src="/js/angular-cookies.js"></script>
    <script src="/js/taggedInfiniteScroll.min.js"></script>
    <script src="/js/zepto.min.js"></script>
    <script src="/js/mobiscroll.custom-2.17.1.min.js"></script>
    <script src="/js/app.js"></script>
</head>

<body ng-app="App" ng-controller="Controller">
	<ion-list>
		<ion-item ng-class="{'item-icon-right': isSubmit}" ng-click="clickType();">
			班级编号
			<div style="display:none;">
				<select id="type" ng-model="purchase.type" ng-options="item as item.text for item in types "></select>
			</div>
			<span class="item-note" style="color:#444;">{{purchase.type.text}}</span>
			<i class="icon material-icons item-note" ng-show="isSubmit">&#xe5cc;</i>
		</ion-item>
		<ion-item style="margin-top:10px;" class="item-input">
			采购金额
			<div style="padding-left:10px;">
				<input type="number" style="width:100%; font-size:14px; background-color:transparent;" ng-model="purchase.day" ng-pattern="/^[0-9]+$/" ng-readonly="{{!isSubmit}}"></input>
			</div>
		</ion-item>
		<ion-item style="margin-top:10px;">
			<div style="position:absolute;">采购内容</div>
			<div style="padding-left:80px;">
				<textarea rows="5" style="width:100%; font-size:14px; background-color:transparent;" ng-model="purchase.content" ng-readonly="{{!isSubmit}}"></textarea>
			</div>
		</ion-item>
	</ion-list>
	<div style="margin:30px;" ng-show="! isSubmit">
		<ol class="timeline">
			<li class="tl-node" ng-repeat="history in historyList">
				<div class="tl-stamp">{{history.createTime}}</div>
				<div class="tl-content">{{history.stepName}}</div>
				<div>{{history.userName}}{{history.auditResult}}</div>
			</li>
		</ol>
	</div>
    <div style="margin-top:30px;" ng-show="isSubmit" class="row">
    	<div class="col">
        	<button class="button button-full button-positive" ng-click="saveOrUpdate(false);">保存</button>
    	</div>
    	<div class="col">
        	<button class="button button-full button-positive" ng-click="saveOrUpdate(true);">保存并提交审核</button>
    	</div>
    </div>
</body>

</html>
<script>
(function() {
var app = angular.module("App", ["ionic", "ngCookies", "tagged.directives.infiniteScroll"])
    .controller('Controller', function($scope, $http, $ionicLoading, $timeout, $cookieStore) {
    	var userId = $cookieStore.get(CookieUserId);
    	var id = "";
		var action = "save";
    	$scope.purchase = {};
    	$scope.purchase.type = {
    		value: "",
    		text: ""
    	};
    	$scope.isSubmit = false;
    	$scope.historyList = [];

		$ionicLoading.show({
            template: LoadingTemplate
        });

        getSetting = function(payload) {
			userId = payload.appUserId;
		}

        if(isApp) {
			window.location.href = "webviewplus://" + encodeURIComponent("{\"action\":\"" + ActionSetTitle + "\",\"data\":{\"text\":\"我的请假\"}}");

			$timeout(function() {
				window.location.href = "webviewplus://" + encodeURIComponent("{\"action\":\"" + ActionGetSetting + "\",\"data\":{}}");
		    }, 1);
		}

    	$scope.types = [{
    		value: "SJ",
    		text: "事假"
    	}, {
    		value: "BJ",
    		text: "病假"
    	}, {
    		value: "NJ",
    		text: "年假"
    	}, {
    		value: "TX",
    		text: "调休"
    	}, {
    		value: "HJ",
    		text: "婚假"
    	}, {
    		value: "CJ",
    		text: "产假"
    	}]

		init = function() {
			$scope.isSubmit = true;

			$timeout(function() {
				$('#type').mobiscroll().select({
			        theme: 'ios',
			        lang: 'zh',
			        display: 'bottom'
			    });

			    $('#type').hide();

				$('#start').mobiscroll().date({
			        theme: 'ios',
			        lang: 'zh',
			        dateFormat: 'yyyy-mm-dd',
			        display: 'bottom'
			    });

				$('#end').mobiscroll().date({
			        theme: 'ios',
			        lang: 'zh',
			        dateFormat: 'yyyy-mm-dd',
			        display: 'bottom'
			    });
			});

			$scope.clickType = function() {
				$('#type').mobiscroll('show');
			}

			$scope.clickStart = function() {
				$('#start').mobiscroll('show');
			}

			$scope.clickEnd = function() {
				$('#end').mobiscroll('show');
			}
		}

		load = function() {
			$http({
	            method: "POST",
	            url: "/purchase/find",
	            headers: {
	                "Content-Type": "application/json;charset=utf-8"
	            },
	            data: {
	            	id: id
	            }
	        }).success(function(response) {
	            if (response.result) {
	            	for(var i = 0; i < $scope.types.length; i++) {
						if(response.data.type == $scope.types[i].value) {
							$scope.purchase.type = $scope.types[i];
							break;
						}
	            	}

					$scope.purchase.type.value = response.data.type;
					$scope.purchase.day = Number(response.data.day);
					$scope.purchase.content = decodeURIComponent(response.data.content);

					if(response.data.instanceState == "START") {
						init();
					} else {
						loadHistory(response.data.instanceId);
					}

	            	$ionicLoading.hide();
				} else {
					$ionicLoading.show({
						template: response.message,
				      	duration: WaitDelay
				    });
				}
	        });
        };

        loadHistory = function(instanceId) {
			$http({
	            method: "POST",
	            url: "/history/list",
	            headers: {
	                "Content-Type": "application/json;charset=utf-8"
	            },
	            data: {
	            	instanceId: instanceId
	            }
	        }).success(function(response) {
	            if (response.result) {
					$scope.historyList = response.data;
				}
	        });
        };

		$scope.saveOrUpdate = function(isAudit) {
			var message = "";

			if(isNullOrEmpty($scope.purchase.type.value)) {
				message += "请选择请假类型!<br/>";
			}

			if(isNullOrEmpty($scope.purchase.day)) {
				message += "请填写请假天数!<br/>";
			}

			if(isNullOrEmpty($scope.purchase.content)) {
				message += "请填写请假理由!<br/>";
			}

			if(! isNullOrEmpty(message)) {
				$ionicLoading.show({
					template: message,
			      	duration: WaitDelay
			    });

			    return;
			}

			$ionicLoading.show({
	            template: LoadingTemplate
	        });

			$http({
				method: "POST",
				url: "/purchase/" + action,
				headers: {
					"Content-Type": "application/json;charset=utf-8"
				},
				data: {
	            	userId: userId,
					id: id,
					type: $scope.purchase.type.value,
					day: $scope.purchase.day,
					content: encodeURIComponent($scope.purchase.content),
					isAudit: isAudit
				}
			}).success(function(response) {
				if (response.result) {
					$ionicLoading.show({
						template: "提交成功!",
				      	duration: WaitDelay
				    });

					$timeout(function(){
						window.location.href = "webviewplus://" + encodeURIComponent("{\"action\":\"" + ActionSetBackAndRefresh + "\",\"data\":{}}");
				    }, WaitDelay);
				} else {
					$ionicLoading.show({
						template: response.message,
				      	duration: WaitDelay
				    });
				}
			});
		}

		if(isNullOrEmpty(getUrlParam("id"))) {
			init();

			$ionicLoading.hide();
		} else {
			id = getUrlParam("id");

			action = "update";

			load();
		}
	});
})();
</script>
